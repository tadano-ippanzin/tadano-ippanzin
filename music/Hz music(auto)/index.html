<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Auto Composition - Instant</title>
    <style>
        body { font-family: monospace; background: #111; color: #0f0; margin: 0; padding: 20px; }
        .toolbar { background: #222; padding: 10px; display: flex; gap: 10px; border: 1px solid #0f0; margin-bottom: 10px; }
        #editor { width: 100%; height: 400px; background: #000; border: 1px solid #0f0; position: relative; overflow: auto; cursor: crosshair; }
        .note { position: absolute; background: #0f0; border: 1px solid #000; font-size: 8px; color: #000; overflow: hidden; }
        input { background: #000; color: #0f0; border: 1px solid #0f0; width: 60px; }
    </style>
</head>
<body>
<div class="toolbar">
    BPM:<input type="number" id="bpm" value="120">
    HARM:<input type="number" id="harm" value="1">
    GLISS(Hz):<input type="number" id="gliss" value="0">
    <button onclick="play()">▶ PLAY</button>
    <button onclick="notes=[]">CLEAR</button>
</div>
<div id="editor" onclick="addNote(event)"></div>
<script>
    let audioCtx = null;
    let notes = [];
    function addNote(e) {
        if(e.target !== e.currentTarget) return;
        const rect = e.currentTarget.getBoundingClientRect();
        notes.push({ x: e.clientX - rect.left, y: e.clientY - rect.top });
        render();
    }
    function render() {
        const ed = document.getElementById('editor');
        ed.innerHTML = '';
        notes.forEach(n => {
            const d = document.createElement('div');
            d.className = 'note';
            d.style.left = n.x + 'px'; d.style.top = n.y + 'px';
            d.style.width = '40px'; d.style.height = '20px';
            d.innerText = (1000 - n.y) + 'Hz';
            ed.appendChild(d);
        });
    }
    function play() {
        if (!audioCtx) audioCtx = new AudioContext();
        const now = audioCtx.currentTime;
        const bpm = document.getElementById('bpm').value;
        const harm = document.getElementById('harm').value;
        const gliss = parseFloat(document.getElementById('gliss').value);
        notes.forEach(n => {
            const start = now + (n.x / 100);
            const freq = 1000 - n.y;
            for(let h=1; h<=harm; h++) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const f = freq * h;
                osc.frequency.setValueAtTime(f + gliss, start);
                osc.frequency.setValueAtTime(f, start + 0.1); // 瞬時に本来のHzへ(即時グリッサンド)
                gain.gain.setValueAtTime(0.1/h, start);
                gain.gain.setValueAtTime(0, start + 0.4); // 0.4秒で即停止
                osc.connect(gain).connect(audioCtx.destination);
                osc.start(start);
                osc.stop(start + 0.45);
            }
        });
    }
</script>
</body>
</html>
