<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Freq System (UFATSAD)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #00ff41; --panel: #111; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--accent); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .toolbar { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--accent); display: flex; gap: 8px; flex-wrap: wrap; font-size: 12px; }
        .group { border: 1px solid #333; padding: 5px; display: flex; gap: 5px; align-items: center; }
        #viewport { flex-grow: 1; overflow: auto; position: relative; background: #000; }
        #canvas { width: 5000px; height: 1200px; position: relative; cursor: crosshair; }
        .note { position: absolute; background: rgba(0,255,65,0.4); border: 1px solid var(--accent); color: white; font-size: 10px; }
        button { background: var(--accent); color: #000; border: none; padding: 4px 8px; cursor: pointer; font-weight: bold; }
        input[type="file"] { display: none; }
        .file-label { background: #333; color: #0f0; padding: 4px 8px; cursor: pointer; border: 1px solid var(--accent); }
    </style>
</head>
<body>

<div class="toolbar">
    <div class="group">
        <strong>COMP:</strong>
        <button onclick="play()">PLAY</button>
        <button onclick="stop()">STOP</button>
    </div>

    <div class="group">
        <strong>LOAD (Any):</strong>
        <label class="file-label">üìÇ UPLOAD<input type="file" id="import-file" onchange="handleImport(this)"></label>
    </div>

    <div class="group">
        <strong>SAVE DATA:</strong>
        <button onclick="exportSingle('json')">JSON</button>
        <button onclick="exportSingle('xml')">XML</button>
        <button onclick="exportSingle('bin')">BIN</button>
        <button onclick="exportSingle('midi')">MIDI</button>
        <button onclick="exportHTML()">HTML/HTM</button>
    </div>

    <div class="group">
        <strong>AUDIO:</strong>
        <button onclick="exportAudio('wav')">WAV</button>
        <button onclick="exportAudio('mp3')">MP3</button>
    </div>

    <div class="group" style="border-color: #ff0;">
        <strong>ARCHIVE:</strong>
        <button onclick="exportUFATSAD()" style="background:#ff0">SAVE .UFATSAD (ZIP)</button>
    </div>
</div>

<div id="viewport">
    <div id="canvas" onclick="createNote(event)"></div>
</div>

<script>
    let notes = [];
    let audioCtx = null;

    // --- Âü∫Êú¨Êìç‰Ωú ---
    function createNote(e) {
        if(e.target !== e.currentTarget) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const n = { id: Date.now(), x: Math.floor((e.clientX - rect.left)/25)*25, y: e.clientY - rect.top, w: 100, hz: (1200 - (e.clientY - rect.top)).toFixed(1) };
        notes.push(n);
        render();
    }

    function render() {
        const c = document.getElementById('canvas');
        c.querySelectorAll('.note').forEach(n => n.remove());
        notes.forEach(n => {
            const d = document.createElement('div');
            d.className = 'note';
            d.style.left = n.x+'px'; d.style.top = (n.y-10)+'px'; d.style.width = n.w+'px'; d.style.height = '20px';
            d.innerText = n.hz;
            d.oncontextmenu = (e) => { e.preventDefault(); notes = notes.filter(x => x.id !== n.id); render(); };
            c.appendChild(d);
        });
    }

    // --- „Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ ---
    async function handleImport(input) {
        const file = input.files[0];
        if(!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        
        if(ext === 'ufatsad' || ext === 'zip') {
            const zip = await JSZip.loadAsync(file);
            const data = await zip.file("sequence.json").async("string");
            notes = JSON.parse(data);
        } else if(ext === 'json') {
            notes = JSON.parse(await file.text());
        } else if(ext === 'xml') {
            // XML„Éë„Éº„ÇπÂá¶ÁêÜ (Á∞°ÊòìÁâà)
            const txt = await file.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(txt, "text/xml");
            const items = xmlDoc.getElementsByTagName("note");
            notes = Array.from(items).map(i => ({
                id: Date.now() + Math.random(),
                hz: i.getElementsByTagName("hz")[0].textContent,
                x: parseInt(i.getElementsByTagName("start")[0].textContent),
                y: 1200 - parseFloat(i.getElementsByTagName("hz")[0].textContent),
                w: parseInt(i.getElementsByTagName("duration")[0].textContent)
            }));
        }
        render();
    }

    // --- „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂá¶ÁêÜ ---
    function download(blob, name) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
    }

    function exportSingle(type) {
        let content, mime;
        if(type === 'json') {
            content = JSON.stringify(notes);
            mime = 'application/json';
        } else if(type === 'xml') {
            content = `<?xml version="1.0"?><seq>${notes.map(n=>`<note><hz>${n.hz}</hz><start>${n.x}</start><duration>${n.w}</duration></note>`).join('')}</seq>`;
            mime = 'text/xml';
        }
        download(new Blob([content], {type: mime}), `export.${type}`);
    }

    function exportHTML() {
        const html = `<html><body><script>const notes=${JSON.stringify(notes)};/* Player Logic Here */<\/script></body></html>`;
        download(new Blob([html], {type: 'text/html'}), "project.html");
    }

    // --- Á©∂Ê•µ„ÅÆ„Ç¢„Éº„Ç´„Ç§„Éñ: .UFATSAD (ZIP) ---
    async function exportUFATSAD() {
        const zip = new JSZip();
        zip.file("sequence.json", JSON.stringify(notes));
        zip.file("readme.txt", "Tadano-Ippanzin Frequency Project Archive\nFormat: UFATSAD");
        
        // XML„Å™„Å©„ÇÇÂêåÊ¢±
        const xml = `<seq>${notes.map(n=>`<note><hz>${n.hz}</hz></note>`).join('')}</seq>`;
        zip.file("sequence.xml", xml);

        const content = await zip.generateAsync({type:"blob"});
        download(content, "project.ufatsad"); // Êã°ÂºµÂ≠ê„ÇíÁã¨Ëá™„ÅÆ„ÇÇ„ÅÆ„Å´
    }

    // Èü≥Â£∞„Ç®„ÇØ„Çπ„Éù„Éº„Éà(WAV)„Å™„Å©„ÅØÂâç„ÅÆ„Ç≥„Éº„Éâ„ÇíÊµÅÁî®...
</script>
</body>
</html>
