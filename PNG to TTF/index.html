<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ç°¡å˜TTFãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; background: #f4f4f9; padding: 20px; }
        .upload-area { border: 3px dashed #bbb; padding: 30px; text-align: center; background: white; cursor: pointer; border-radius: 10px; }
        .upload-area:hover { background-color: #f0f8ff; border-color: #007bff; }
        .card-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .char-card { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .char-card img { width: 80px; height: 80px; object-fit: contain; border: 1px solid #ddd; }
        .char-card input { width: 40px; font-size: 20px; text-align: center; margin-top: 5px; padding: 5px; }
        .controls { margin-top: 30px; text-align: center; padding: 20px; background: white; border-radius: 8px; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; font-size: 18px; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 10px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

    <h1>ğŸ¨ ç”»åƒã‹ã‚‰TTFãƒ•ã‚©ãƒ³ãƒˆã‚’ä½œæˆ</h1>
    
    <div class="upload-area" onclick="document.getElementById('file-input').click()">
        <h3>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒ(PNG)ã‚’é¸æŠ</h3>
        <p>â€»èƒŒæ™¯ãŒé€æ˜ã€ã¾ãŸã¯ç™½èƒŒæ™¯ã®é»’æ–‡å­—ç”»åƒã‚’æ¨å¥¨</p>
        <input type="file" id="file-input" multiple accept="image/png" style="display:none">
    </div>

    <div id="card-list" class="card-list"></div>

    <div class="controls">
        <label>ãƒ•ã‚©ãƒ³ãƒˆå: <input type="text" id="font-name" value="MyFont" style="padding: 5px;"></label>
        <br><br>
        <button id="generate-btn">TTFãƒ•ã‚©ãƒ³ãƒˆã‚’ç”Ÿæˆï¼†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <div id="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>

    <script>
        const fileInput = document.getElementById('file-input');
        const cardList = document.getElementById('card-list');
        const generateBtn = document.getElementById('generate-btn');
        const statusDiv = document.getElementById('status');
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ãƒªã‚¹ãƒˆ
        let fontItems = [];

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            statusDiv.innerText = `${files.length}æšã®ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...`;

            for (let file of files) {
                await processFile(file);
            }
            statusDiv.innerText = "æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
        });

        // ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†
        function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ–‡å­—ã‚’æ¨æ¸¬ (1æ–‡å­—ç›®ã‚’å–å¾—ã€‚ã‚‚ã—æ•°å­—ãªã‚‰ãã®ã¾ã¾)
                    let suggestedChar = file.name.split('.')[0].charAt(0);
                    
                    // UIä½œæˆ
                    const div = document.createElement('div');
                    div.className = 'char-card';
                    div.innerHTML = `
                        <img src="${dataUrl}">
                        <div>
                            <input type="text" value="${suggestedChar}" maxlength="1" class="char-input">
                        </div>
                    `;
                    
                    cardList.appendChild(div);
                    
                    // ãƒ‡ãƒ¼ã‚¿ä¿æŒ
                    fontItems.push({
                        imgSrc: dataUrl,
                        inputElement: div.querySelector('.char-input')
                    });
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        // ---------------------------------------------------------
        //  ã“ã“ãŒæ ¸å¿ƒéƒ¨åˆ†ï¼šç”»åƒã‚’ãƒ™ã‚¯ã‚¿ãƒ¼å¤‰æ›ã—ã¦TTFã«ã™ã‚‹
        // ---------------------------------------------------------
        generateBtn.addEventListener('click', async () => {
            if (fontItems.length === 0) return alert("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");
            
            generateBtn.disabled = true;
            statusDiv.innerText = "å‡¦ç†ä¸­... ç”»åƒã‚’è§£æã—ã¦ãƒ™ã‚¯ã‚¿ãƒ¼åŒ–ã—ã¦ã„ã¾ã™...";

            try {
                // 1. åŸºæœ¬ã®ãƒ•ã‚©ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                // (ç©ºã®ãƒ•ã‚©ãƒ³ãƒˆå…¥ã‚Œç‰©ã‚’ç”¨æ„)
                const font = new opentype.Font({
                    familyName: document.getElementById('font-name').value,
                    styleName: 'Regular',
                    unitsPerEm: 1000,
                    ascender: 800,
                    descender: -200,
                    glyphs: []
                });

                // .notdef (æœªå®šç¾©æ–‡å­—) ã‚’è¿½åŠ ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ä½œæˆ
                const notdefGlyph = new opentype.Glyph({
                    name: '.notdef',
                    unicode: 0,
                    advanceWidth: 500,
                    path: new opentype.Path()
                });
                font.glyphs.push(0, notdefGlyph); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã«ç™»éŒ²

                // 2. å„ç”»åƒã‚’å‡¦ç†ã—ã¦ã‚°ãƒªãƒ•(æ–‡å­—)åŒ–ã™ã‚‹
                for (let item of fontItems) {
                    const char = item.inputElement.value;
                    if (!char) continue; // æ–‡å­—ãŒç©ºãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

                    // ImageTracerã‚’ä½¿ã£ã¦ç”»åƒã‚’SVGãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
                    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ltres(ç²¾åº¦), colorsãªã©èª¿æ•´å¯èƒ½
                    const options = { ltres:1, qtres:1, scale:1, strokewidth:0, viewbox:true };
                    const svgData = await new Promise(resolve => {
                        ImageTracer.imageToSVG(item.imgSrc, (svgstr) => {
                            resolve(svgstr);
                        }, options);
                    });
                    
                    // SVGæ–‡å­—åˆ—ã‹ã‚‰ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿(då±æ€§)ã‚’æŠ½å‡ºã™ã‚‹ç°¡æ˜“æ­£è¦è¡¨ç¾
                    // â€»ImageTracerã¯è¤‡æ•°ã®pathã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹ãŒã€ã“ã“ã§ã¯çµåˆã¾ãŸã¯æœ€åˆã‚’ä½¿ç”¨
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(svgData, "image/svg+xml");
                    const paths = doc.querySelectorAll('path');

                    const opentypePath = new opentype.Path();
                    
                    // æŠ½å‡ºã•ã‚ŒãŸSVGãƒ‘ã‚¹ã‚’opentypeå½¢å¼ã«å¤‰æ›
                    // åº§æ¨™å¤‰æ›: SVG(YãŒä¸‹å‘ã) -> TTF(YãŒä¸Šå‘ã) ã«åˆã‚ã›ã‚‹ãŸã‚åè»¢ãŒå¿…è¦
                    // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«opentype.jsã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ‘ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™
                    
                    paths.forEach(p => {
                        const d = p.getAttribute('d');
                        if(d) {
                            // opentype.jsã®fromSVGã§å¤‰æ›ã§ãã‚‹å ´åˆãŒã‚ã‚‹ãŒ
                            // åº§æ¨™ç³»ã‚’åˆã‚ã›ã‚‹ã®ãŒé›£ã—ã„ãŸã‚ã€ãƒ‘ã‚¹ã‚³ãƒãƒ³ãƒ‰ã‚’è§£æã—ã¦åè»¢ã•ã›ã‚‹ã®ãŒä¸€èˆ¬çš„
                            // ä»Šå›ã¯ç°¡æ˜“çš„ã«path2dã¨ã—ã¦èª­ã¿è¾¼ã¾ã›ã¾ã™
                            const tmpPath = opentype.Path.fromSVG(d);
                            
                            // åº§æ¨™èª¿æ•´ (ã‚¹ã‚±ãƒ¼ãƒ«ã¨åè»¢)
                            // ImageTracerã®çµæœã¯ç”»åƒã‚µã‚¤ã‚ºä¾å­˜ã€‚1000x1000ã®emboxã«åˆã‚ã›ã‚‹
                            const scale = 1000 / 100; // ä»®ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆç”»åƒã‚µã‚¤ã‚ºã«ã‚ˆã‚Šèª¿æ•´å¿…è¦ï¼‰
                            
                            for (let cmd of tmpPath.commands) {
                                // Yè»¸ã‚’åè»¢ã•ã›ã¦ã€ä½ç½®ã‚’èª¿æ•´ (800ã¯ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®é«˜ã•)
                                const yOffset = 800;
                                const scaleFactor = 5; // ç”»åƒã‚µã‚¤ã‚ºã«å¿œã˜ã¦å¤‰ãˆã‚‹å¿…è¦ã‚ã‚Š
                                
                                if (cmd.x) cmd.x = cmd.x * scaleFactor;
                                if (cmd.y) cmd.y = 800 - (cmd.y * scaleFactor);
                                if (cmd.x1) cmd.x1 = cmd.x1 * scaleFactor;
                                if (cmd.y1) cmd.y1 = 800 - (cmd.y1 * scaleFactor);
                                if (cmd.x2) cmd.x2 = cmd.x2 * scaleFactor;
                                if (cmd.y2) cmd.y2 = 800 - (cmd.y2 * scaleFactor);
                                
                                opentypePath.commands.push(cmd);
                            }
                        }
                    });

                    // ã‚°ãƒªãƒ•ã‚’ä½œæˆ
                    const glyph = new opentype.Glyph({
                        name: char,
                        unicode: char.charCodeAt(0),
                        advanceWidth: 1000,
                        path: opentypePath
                    });
                    
                    font.glyphs.push(0, glyph);
                }

                // 3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                statusDiv.innerText = "ç”Ÿæˆå®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚";
                font.download();
                
            } catch (err) {
                console.error(err);
                statusDiv.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message;
                alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
            } finally {
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
